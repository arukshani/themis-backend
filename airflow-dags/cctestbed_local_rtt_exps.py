from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import datetime, timedelta

default_args = {
    "owner": "airflow",
    "depends_on_past": False,
    "start_date": datetime(2015, 6, 1),
    "email": ["airflow@airflow.com"],
    "email_on_failure": False,
    "email_on_retry": False,
    "retries": 5,
    "retry_delay": timedelta(minutes=1),
    "queue":"cctestbed_aws",
    # 'queue': 'bash_queue',
    # 'pool': 'backfill',
    # 'priority_weight': 10,
    # 'end_date': datetime(2016, 1, 1),
}

ntwrk_conditions = [(5, 35, 16), (5, 38, 16), (5, 31, 16), (5, 43, 16), (5, 26, 16), (5,52, 16), (5, 17, 16), (5, 61, 16), (5, 8, 16), (5, 70, 16), (5, 85, 64), (5, 93, 64), (5, 76, 64), (5, 106, 64), (5, 63, 64), (5, 127, 64), (5, 42, 64), (5, 148, 64), (5, 21, 64), (5, 170, 64), (5, 130, 64), (5, 143, 64), (5, 117, 64), (5, 162, 64), (5, 97, 64), (5, 195, 64), (5, 65, 64), (5, 227, 64), (5, 32, 64), (5, 260, 64), (5, 275, 128), (5, 302, 128), (5, 247, 128), (5, 343, 128), (5, 206, 128), (5, 412, 128), (5, 137, 128), (5, 481, 128), (5, 68, 128), (5, 550, 128), (10, 35, 32), (10, 38, 32), (10, 31, 32), (10, 43, 32), (10, 26, 32), (10, 52, 32), (10, 17, 32), (10, 61, 32), (10, 8, 32), (10, 70, 32), (10, 85, 128), (10, 93, 128), (10, 76, 128), (10, 106, 128), (10, 63, 128), (10, 127, 128), (10, 42, 128), (10, 148, 128), (10, 21, 128), (10, 170, 128), (10, 130, 128), (10, 143, 128), (10, 117, 128), (10, 162, 128), (10, 97, 128), (10, 195, 128), (10, 65, 128), (10, 227, 128), (10, 32, 128), (10, 260, 128), (10, 275, 256), (10, 302, 256), (10, 247, 256), (10, 343, 256), (10, 206, 256), (10, 412, 256), (10, 137, 256), (10, 481, 256), (10, 68, 256), (10, 550, 256), (15, 35, 64), (15, 38, 64), (15, 31, 64), (15, 43, 64), (15, 26, 64), (15, 52, 64), (15, 17, 64), (15, 61, 64), (15, 8, 64), (15, 70, 64), (15, 85, 128), (15, 93, 128), (15, 76, 128), (15, 106, 128), (15, 63, 128), (15, 127, 128), (15, 42, 128), (15, 148, 128), (15, 21, 128), (15, 170, 128), (15, 130, 256), (15, 143, 256), (15, 117, 256), (15, 162, 256), (15, 97, 256), (15, 195, 256), (15, 65, 256), (15, 227, 256), (15, 32, 256), (15, 260, 256), (15, 275, 512), (15, 302, 512), (15, 247, 512), (15, 343, 512), (15, 206, 512), (15, 412, 512), (15, 137, 512), (15, 481, 512), (15, 68, 512), (15, 550, 512)]

ntwrk_cmdline_args = ''
for btlbw, rtt, queue_size in ntwrk_conditions:
    ntwrk_cmdline_args += '-n {} {} {} '.format(btlbw, rtt, queue_size)

with DAG("cctestbed_local_rtt",
         default_args=default_args,
         schedule_interval=None) as dag:
    run_experiment = BashOperator(task_id='run_experiment',
                                  bash_command=(
                                      "cd /opt/cctestbed && "
                                      "python3.6 /opt/cctestbed/ccalg_predict_iperf.py -r local -c {{ dag_run.conf['cca'] }} --force" + ntwrk_cmdline_args))

